{% extends "base.html" %}

{% block title %}Scoreboard - {{ ctf_name }}{% endblock %}

{% block extra_css %}
<style>
    .scoreboard-table { font-size: 0.95rem; }
    .rank-badge { 
        width: 40px; 
        height: 40px; 
        display: inline-flex; 
        align-items: center; 
        justify-content: center;
        border-radius: 50%;
    }
    .gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
    .silver { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); }
    .bronze { background: linear-gradient(135deg, #CD7F32, #B8860B); }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-trophy-fill text-warning"></i> Live Scoreboard
    </h2>
    <div>
        <span class="badge bg-success pulse">
            <i class="bi bi-circle-fill"></i> LIVE
        </span>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover scoreboard-table" id="scoreboardTable">
                <thead>
                    <tr>
                        <th width="80">Rank</th>
                        <th>Team</th>
                        <th width="100">Score</th>
                        <th width="100">Solves</th>
                        <th width="180">Last Solve</th>
                    </tr>
                </thead>
                <tbody id="scoreboardBody">
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Toast for new solves -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="solveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-trophy-fill me-2"></i>
            <strong class="me-auto">New Solve!</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="solveToastBody">
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let socket;
let scoreboardData = [];

// Connect to WebSocket
function connectWebSocket() {
    socket = io('/live', {
        transports: ['websocket', 'polling']
    });
    
    socket.on('connect', function() {
        console.log('Connected to live updates');
        socket.emit('join_scoreboard');
        socket.emit('request_scoreboard');
    });
    
    socket.on('scoreboard_update', function(data) {
        console.log('Scoreboard update received', data);
        scoreboardData = data;
        updateScoreboardTable();
    });
    
    socket.on('new_solve', function(data) {
        console.log('New solve:', data);
        showSolveToast(data);
        // Request fresh scoreboard
        socket.emit('request_scoreboard');
    });
    
    socket.on('challenge_update', function(data) {
        console.log('Challenge points updated:', data);
    });
    
    socket.on('disconnect', function() {
        console.log('Disconnected from live updates');
    });
}

// Update scoreboard table
function updateScoreboardTable() {
    const tbody = document.getElementById('scoreboardBody');
    tbody.innerHTML = '';
    
    if (scoreboardData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No teams yet</td></tr>';
        return;
    }
    
    scoreboardData.forEach((team, index) => {
        const tr = document.createElement('tr');
        
        // Rank
        const rankTd = document.createElement('td');
        if (team.rank <= 3) {
            const badgeClass = team.rank === 1 ? 'gold' : (team.rank === 2 ? 'silver' : 'bronze');
            rankTd.innerHTML = `<span class="rank-badge ${badgeClass} fw-bold text-white">${team.rank}</span>`;
        } else {
            rankTd.innerHTML = `<span class="fs-5">#${team.rank}</span>`;
        }
        
        // Team name
        const nameTd = document.createElement('td');
        let nameHtml = `<strong>${escapeHtml(team.name)}</strong>`;
        if (team.affiliation) {
            nameHtml += `<br><small class="text-muted">${escapeHtml(team.affiliation)}</small>`;
        }
        nameTd.innerHTML = nameHtml;
        
        // Score
        const scoreTd = document.createElement('td');
        scoreTd.innerHTML = `<span class="badge bg-primary fs-6">${team.score}</span>`;
        
        // Solves
        const solvesTd = document.createElement('td');
        solvesTd.innerHTML = `<i class="bi bi-trophy"></i> ${team.solves}`;
        
        // Last solve
        const lastSolveTd = document.createElement('td');
        if (team.last_solve) {
            const date = new Date(team.last_solve);
            lastSolveTd.innerHTML = `<small class="text-muted">${formatDate(date)}</small>`;
        } else {
            lastSolveTd.innerHTML = '<small class="text-muted">-</small>';
        }
        
        tr.appendChild(rankTd);
        tr.appendChild(nameTd);
        tr.appendChild(scoreTd);
        tr.appendChild(solvesTd);
        tr.appendChild(lastSolveTd);
        
        tbody.appendChild(tr);
    });
}

// Show toast notification for new solve
function showSolveToast(data) {
    const toastBody = document.getElementById('solveToastBody');
    toastBody.innerHTML = `
        <strong>${escapeHtml(data.team || data.user)}</strong> solved 
        <strong>${escapeHtml(data.challenge)}</strong> 
        for <span class="badge bg-warning text-dark">${data.points}</span> points!
    `;
    
    const toast = new bootstrap.Toast(document.getElementById('solveToast'));
    toast.show();
}

// Utility functions
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function formatDate(date) {
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);
    
    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return `${Math.floor(diff / 86400)}d ago`;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
    
    // Fallback: Load scoreboard via API if WebSocket fails
    setTimeout(function() {
        if (scoreboardData.length === 0) {
            fetch('/scoreboard/api/data')
                .then(response => response.json())
                .then(data => {
                    scoreboardData = data;
                    updateScoreboardTable();
                })
                .catch(error => console.error('Error loading scoreboard:', error));
        }
    }, 2000);
});
</script>
{% endblock %}
