{% extends "base.html" %}

{% block title %}Challenge Branching - Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-diagram-3"></i> Challenge Branching & Prerequisites</h2>
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Admin
                </a>
            </div>

            <!-- Info Alert -->
            <div class="alert alert-info">
                <h5><i class="bi bi-info-circle"></i> Challenge Branching System</h5>
                <p><strong>Multiple Flags:</strong> Each challenge can have multiple flags. Each flag can unlock different hidden challenges.</p>
                <p><strong>Prerequisites:</strong> Challenges can require other challenges to be solved before they become visible.</p>
                <p><strong>Unlock Modes:</strong></p>
                <ul>
                    <li><strong>None:</strong> Challenge is always visible</li>
                    <li><strong>Prerequisite:</strong> Challenge becomes visible after prerequisites are solved</li>
                    <li><strong>Flag Unlock:</strong> Challenge is hidden until unlocked by a specific flag from another challenge</li>
                </ul>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-4" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="simple-branching-tab" data-bs-toggle="tab" data-bs-target="#simple-branching" type="button">
                        <i class="bi bi-diagram-3"></i> Configure Branching
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="flags-tab" data-bs-toggle="tab" data-bs-target="#flags" type="button">
                        <i class="bi bi-flag"></i> Manage Flags
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="prerequisites-tab" data-bs-toggle="tab" data-bs-target="#prerequisites" type="button">
                        <i class="bi bi-diagram-2"></i> Prerequisites
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="unlock-modes-tab" data-bs-toggle="tab" data-bs-target="#unlock-modes" type="button">
                        <i class="bi bi-lock"></i> Advanced Settings
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Simple Branching Tab -->
                <div class="tab-pane fade show active" id="simple-branching" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="bi bi-diagram-3"></i> Quick Branching Setup</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">
                                Select a parent challenge, choose one of its flags, and select which challenge it should unlock.
                            </p>
                            
                            <form id="quickBranchingForm">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label"><strong>1. Parent Challenge</strong></label>
                                        <select class="form-select" id="parent_challenge" required>
                                            <option value="">Select parent challenge...</option>
                                            {% for challenge in challenges %}
                                            <option value="{{ challenge.id }}">{{ challenge.name }} ({{ challenge.category }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label"><strong>2. Select Flag</strong></label>
                                        <select class="form-select" id="parent_flag" required disabled>
                                            <option value="">Select parent first...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label"><strong>3. Unlocks Challenge</strong></label>
                                        <select class="form-select" id="child_challenge" required>
                                            <option value="">Select child challenge...</option>
                                            {% for challenge in challenges %}
                                            <option value="{{ challenge.id }}">{{ challenge.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-link"></i> Create Branching Connection
                                    </button>
                                </div>
                            </form>
                            
                            <hr class="my-4">
                            
                            <h6>Current Branching Connections</h6>
                            <div id="branchingConnections" class="mt-3">
                                <!-- Will be populated via AJAX -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Flags Tab -->
                <div class="tab-pane fade show active" id="flags" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-plus-circle"></i> Add Flag to Challenge</h5>
                        </div>
                        <div class="card-body">
                            <form id="addFlagForm">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Challenge</label>
                                        <select class="form-select" name="challenge_id" required>
                                            <option value="">Select challenge...</option>
                                            {% for challenge in challenges %}
                                            <option value="{{ challenge.id }}">{{ challenge.name }} ({{ challenge.category }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Flag Value</label>
                                        <input type="text" class="form-control" name="flag_value" placeholder="flag{example}" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Flag Label (Optional)</label>
                                        <input type="text" class="form-control" name="flag_label" placeholder="Path A, Secret Route, etc.">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Unlocks Challenge (Optional)</label>
                                        <select class="form-select" name="unlocks_challenge_id">
                                            <option value="">None - doesn't unlock anything</option>
                                            {% for challenge in challenges %}
                                            <option value="{{ challenge.id }}">{{ challenge.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">Points Override (Optional)</label>
                                        <input type="number" class="form-control" name="points_override" placeholder="Leave blank for default">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">Case Sensitive</label>
                                        <select class="form-select" name="is_case_sensitive">
                                            <option value="1">Yes</option>
                                            <option value="0">No</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="submit" class="btn btn-primary w-100">Add Flag</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Existing Flags -->
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-list"></i> Existing Flags</h5>
                        </div>
                        <div class="card-body">
                            <div id="flagsList">
                                <!-- Will be populated via AJAX -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prerequisites Tab -->
                <div class="tab-pane fade" id="prerequisites" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-plus-circle"></i> Add Prerequisite</h5>
                        </div>
                        <div class="card-body">
                            <form id="addPrerequisiteForm">
                                <div class="row">
                                    <div class="col-md-5 mb-3">
                                        <label class="form-label">Challenge (requires...)</label>
                                        <select class="form-select" name="challenge_id" required>
                                            <option value="">Select challenge...</option>
                                            {% for challenge in challenges %}
                                            <option value="{{ challenge.id }}">{{ challenge.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-5 mb-3">
                                        <label class="form-label">Prerequisite Challenge (must solve first)</label>
                                        <select class="form-select" name="prerequisite_challenge_id" required>
                                            <option value="">Select prerequisite...</option>
                                            {% for challenge in challenges %}
                                            <option value="{{ challenge.id }}">{{ challenge.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="submit" class="btn btn-primary w-100">Add</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Existing Prerequisites -->
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-list"></i> Existing Prerequisites</h5>
                        </div>
                        <div class="card-body">
                            <div id="prerequisitesList">
                                <!-- Will be populated via AJAX -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Unlock Modes Tab -->
                <div class="tab-pane fade" id="unlock-modes" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-gear"></i> Challenge Unlock Configuration</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Challenge</th>
                                            <th>Category</th>
                                            <th>Unlock Mode</th>
                                            <th>Hidden</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="unlockModesList">
                                        {% for challenge in challenges %}
                                        <tr data-challenge-id="{{ challenge.id }}">
                                            <td><strong>{{ challenge.name }}</strong></td>
                                            <td><span class="badge bg-secondary">{{ challenge.category }}</span></td>
                                            <td>
                                                <select class="form-select form-select-sm unlock-mode-select" data-challenge-id="{{ challenge.id }}">
                                                    <option value="none" {% if challenge.unlock_mode == 'none' %}selected{% endif %}>None (Always Visible)</option>
                                                    <option value="prerequisite" {% if challenge.unlock_mode == 'prerequisite' %}selected{% endif %}>Prerequisite</option>
                                                    <option value="flag_unlock" {% if challenge.unlock_mode == 'flag_unlock' %}selected{% endif %}>Flag Unlock</option>
                                                </select>
                                            </td>
                                            <td>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input is-hidden-toggle" type="checkbox" data-challenge-id="{{ challenge.id }}" {% if challenge.is_hidden %}checked{% endif %}>
                                                </div>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-success update-unlock-btn" data-challenge-id="{{ challenge.id }}">
                                                    <i class="bi bi-check"></i> Update
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load flags and prerequisites on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFlags();
    loadPrerequisites();
    loadBranchingConnections();
});

// Parent challenge selection - load its flags
document.getElementById('parent_challenge')?.addEventListener('change', async function() {
    const challengeId = this.value;
    const flagSelect = document.getElementById('parent_flag');
    
    if (!challengeId) {
        flagSelect.disabled = true;
        flagSelect.innerHTML = '<option value="">Select parent first...</option>';
        return;
    }
    
    try {
        const response = await fetch(`/admin/branching/challenges/${challengeId}/flags`);
        const data = await response.json();
        
        flagSelect.innerHTML = '<option value="">Select a flag...</option>';
        
        if (data.flags && data.flags.length > 0) {
            data.flags.forEach(flag => {
                const option = document.createElement('option');
                option.value = flag.id;
                option.textContent = `${flag.flag_value}${flag.label ? ` (${flag.label})` : ''}`;
                flagSelect.appendChild(option);
            });
            flagSelect.disabled = false;
        } else {
            flagSelect.innerHTML = '<option value="">No flags found for this challenge</option>';
            flagSelect.disabled = true;
        }
    } catch (error) {
        console.error('Error loading flags:', error);
        flagSelect.innerHTML = '<option value="">Error loading flags</option>';
    }
});

// Quick Branching Form
document.getElementById('quickBranchingForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const flagId = document.getElementById('parent_flag').value;
    const childChallengeId = document.getElementById('child_challenge').value;
    
    if (!flagId || !childChallengeId) {
        alert('Please select all fields');
        return;
    }
    
    try {
        const response = await fetch(`/admin/branching/flags/${flagId}/unlock`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                unlocks_challenge_id: childChallengeId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Branching connection created! The child challenge will be hidden until the flag is submitted.');
            this.reset();
            document.getElementById('parent_flag').disabled = true;
            loadBranchingConnections();
            loadFlags();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        alert('Error creating branching: ' + error.message);
    }
});

// Load branching connections
async function loadBranchingConnections() {
    try {
        const response = await fetch('/admin/branching/connections');
        const data = await response.json();
        
        const container = document.getElementById('branchingConnections');
        
        if (data.connections && data.connections.length > 0) {
            let html = '<div class="list-group">';
            
            data.connections.forEach(conn => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${conn.parent_challenge}</strong>
                                <i class="bi bi-arrow-right mx-2"></i>
                                <code>${conn.flag_value}</code>
                                <i class="bi bi-arrow-right mx-2"></i>
                                <span class="badge bg-success">Unlocks: ${conn.child_challenge}</span>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="removeBranching(${conn.flag_id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p class="text-muted">No branching connections configured yet.</p>';
        }
    } catch (error) {
        console.error('Error loading connections:', error);
    }
}

// Remove branching connection
async function removeBranching(flagId) {
    if (!confirm('Remove this branching connection?')) return;
    
    try {
        const response = await fetch(`/admin/branching/flags/${flagId}/unlock`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                unlocks_challenge_id: null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadBranchingConnections();
            loadFlags();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        alert('Error removing branching: ' + error.message);
    }
}

// Add Flag Form
document.getElementById('addFlagForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/admin/branching/flags', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Flag added successfully!');
            this.reset();
            loadFlags();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        alert('Error adding flag: ' + error.message);
    }
});

// Add Prerequisite Form
document.getElementById('addPrerequisiteForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    // Check if same challenge
    if (formData.get('challenge_id') === formData.get('prerequisite_challenge_id')) {
        alert('A challenge cannot be a prerequisite of itself!');
        return;
    }
    
    try {
        const response = await fetch('/admin/branching/prerequisites', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Prerequisite added successfully!');
            this.reset();
            loadPrerequisites();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        alert('Error adding prerequisite: ' + error.message);
    }
});

// Load Flags
async function loadFlags() {
    try {
        const response = await fetch('/admin/branching/flags');
        const data = await response.json();
        
        const flagsList = document.getElementById('flagsList');
        
        if (data.flags && data.flags.length > 0) {
            let html = '<div class="list-group">';
            
            data.flags.forEach(flag => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${flag.challenge_name}</h6>
                                <p class="mb-1"><code>${flag.flag_value}</code></p>
                                ${flag.label ? `<span class="badge bg-info">${flag.label}</span>` : ''}
                                ${flag.unlocks_challenge_name ? `<span class="badge bg-success">Unlocks: ${flag.unlocks_challenge_name}</span>` : ''}
                                ${flag.points_override ? `<span class="badge bg-warning">${flag.points_override} points</span>` : ''}
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteFlag(${flag.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            flagsList.innerHTML = html;
        } else {
            flagsList.innerHTML = '<p class="text-muted">No flags defined yet.</p>';
        }
    } catch (error) {
        console.error('Error loading flags:', error);
    }
}

// Load Prerequisites
async function loadPrerequisites() {
    try {
        const response = await fetch('/admin/branching/prerequisites');
        const data = await response.json();
        
        const prerequisitesList = document.getElementById('prerequisitesList');
        
        if (data.prerequisites && data.prerequisites.length > 0) {
            let html = '<div class="list-group">';
            
            data.prerequisites.forEach(prereq => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${prereq.challenge_name}</strong> requires 
                                <span class="badge bg-primary">${prereq.prerequisite_name}</span>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deletePrerequisite(${prereq.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            prerequisitesList.innerHTML = html;
        } else {
            prerequisitesList.innerHTML = '<p class="text-muted">No prerequisites defined yet.</p>';
        }
    } catch (error) {
        console.error('Error loading prerequisites:', error);
    }
}

// Delete Flag
async function deleteFlag(flagId) {
    if (!confirm('Are you sure you want to delete this flag?')) return;
    
    try {
        const response = await fetch(`/admin/branching/flags/${flagId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadFlags();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        alert('Error deleting flag: ' + error.message);
    }
}

// Delete Prerequisite
async function deletePrerequisite(prereqId) {
    if (!confirm('Are you sure you want to delete this prerequisite?')) return;
    
    try {
        const response = await fetch(`/admin/branching/prerequisites/${prereqId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadPrerequisites();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        alert('Error deleting prerequisite: ' + error.message);
    }
}

// Update Unlock Mode
document.querySelectorAll('.update-unlock-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const challengeId = this.dataset.challengeId;
        const row = document.querySelector(`tr[data-challenge-id="${challengeId}"]`);
        const unlockMode = row.querySelector('.unlock-mode-select').value;
        const isHidden = row.querySelector('.is-hidden-toggle').checked;
        
        try {
            const response = await fetch(`/admin/branching/unlock-mode/${challengeId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    unlock_mode: unlockMode,
                    is_hidden: isHidden
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Unlock mode updated!');
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('Error updating unlock mode: ' + error.message);
        }
    });
});
</script>
{% endblock %}
