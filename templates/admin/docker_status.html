{% extends "base.html" %}

{% block title %}Docker Container Status - Admin - {{ ctf_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        {% include 'admin/_sidebar.html' %}
    </div>
    
    <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-box-seam"></i> Active Docker Containers
            </h2>
            <div>
                <button class="btn btn-outline-primary" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                {% if containers %}
                <button class="btn btn-danger" onclick="deleteAllContainers()">
                    <i class="bi bi-trash"></i> Nuke All
                </button>
                {% endif %}
            </div>
        </div>
        
        {% if containers %}
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="containers-table">
                        <thead>
                            <tr>
                                <th style="cursor: pointer;" onclick="sortTable(0)">ID</th>
                                <th style="cursor: pointer;" onclick="sortTable(1)">User</th>
                                <th style="cursor: pointer;" onclick="sortTable(2)">Team</th>
                                <th style="cursor: pointer;" onclick="sortTable(3)">Challenge</th>
                                <th style="cursor: pointer;" onclick="sortTable(4)">Container ID</th>
                                <th style="cursor: pointer;" onclick="sortTable(5)">Port</th>
                                <th style="cursor: pointer;" onclick="sortTable(6)">Status</th>
                                <th style="cursor: pointer;" onclick="sortTable(7)">Started</th>
                                <th>Expires</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in containers %}
                            <tr id="container-row-{{ c.id }}">
                                <td>{{ c.id }}</td>
                                <td>{{ c.user }}</td>
                                <td>{{ c.team }}</td>
                                <td>{{ c.challenge }}</td>
                                <td><code>{{ c.container_id }}</code></td>
                                <td>{{ c.host_port }}</td>
                                <td>
                                    <span class="badge 
                                        {% if c.status == 'running' %}bg-success
                                        {% elif c.status == 'starting' %}bg-warning
                                        {% else %}bg-secondary{% endif %}">
                                        {{ c.status }}
                                    </span>
                                </td>
                                <td>{{ c.started_at|format_datetime }}</td>
                                <td>{{ c.expires_at|format_datetime }}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" 
                                            onclick="deleteContainer({{ c.id }})" 
                                            title="Delete container">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3 text-muted">
                    <i class="bi bi-info-circle"></i> 
                    Showing {{ containers|length }} active container{{ 's' if containers|length != 1 else '' }}
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            No active containers at the moment.
        </div>
        {% endif %}
    </div>
</div>

<script>
function sortTable(columnIndex) {
    const table = document.getElementById("containers-table");
    let switching = true;
    let dir = "asc";
    let switchcount = 0;
    
    while (switching) {
        switching = false;
        const rows = table.rows;
        
        for (let i = 1; i < (rows.length - 1); i++) {
            let shouldSwitch = false;
            const x = rows[i].getElementsByTagName("TD")[columnIndex];
            const y = rows[i + 1].getElementsByTagName("TD")[columnIndex];
            
            if (dir == "asc") {
                if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                    shouldSwitch = true;
                    break;
                }
            } else if (dir == "desc") {
                if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                    shouldSwitch = true;
                    break;
                }
            }
        }
        
        if (shouldSwitch) {
            const rows = table.rows;
            for (let i = 1; i < (rows.length - 1); i++) {
                const x = rows[i].getElementsByTagName("TD")[columnIndex];
                const y = rows[i + 1].getElementsByTagName("TD")[columnIndex];
                
                if ((dir == "asc" && x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) ||
                    (dir == "desc" && x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase())) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchcount++;
                    break;
                }
            }
        } else {
            if (switchcount == 0 && dir == "asc") {
                dir = "desc";
                switching = true;
            }
        }
    }
}

function deleteContainer(id) {
    if (!confirm('Delete this container?')) return;
    
    fetch(`/admin/docker/containers/${id}/delete`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`container-row-${id}`).remove();
            
            // Check if table is now empty
            const tbody = document.querySelector('#containers-table tbody');
            if (tbody.children.length === 0) {
                location.reload();
            }
        } else {
            alert('Error: ' + (data.error || 'Failed to delete container'));
        }
    })
    .catch(err => {
        alert('Error: ' + err.message);
    });
}

function deleteAllContainers() {
    if (!confirm('Delete ALL containers? This cannot be undone!')) return;
    
    fetch('/admin/docker/containers/delete-all', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete containers'));
        }
    })
    .catch(err => {
        alert('Error: ' + err.message);
    });
}
</script>

<style>
#containers-table th {
    background-color: #f8f9fa;
    position: sticky;
    top: 0;
    z-index: 1;
}

#containers-table th:hover {
    background-color: #e9ecef;
}

#containers-table code {
    background-color: transparent;
    color: #6c757d;
    font-size: 0.875rem;
}
</style>
{% endblock %}
