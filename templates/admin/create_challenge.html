{% extends "base.html" %}

{% block title %}Create Challenge - Admin - {{ ctf_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="admin-sidebar p-3">
            <h5 class="mb-3">Admin Menu</h5>
            <nav class="nav flex-column">
                <a href="{{ url_for('admin.dashboard') }}" class="admin-nav-link">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a href="{{ url_for('admin.manage_challenges') }}" class="admin-nav-link active">
                    <i class="bi bi-puzzle"></i> Challenges
                </a>
                <a href="{{ url_for('admin.manage_users') }}" class="admin-nav-link">
                    <i class="bi bi-people"></i> Users
                </a>
                <a href="{{ url_for('admin.manage_teams') }}" class="admin-nav-link">
                    <i class="bi bi-people-fill"></i> Teams
                </a>
                <a href="{{ url_for('admin.ctf_control') }}" class="admin-nav-link">
                    <i class="bi bi-clock-history"></i> CTF Control
                </a>
                <a href="{{ url_for('admin.settings') }}" class="admin-nav-link">
                    <i class="bi bi-gear"></i> Settings
                </a>
            </nav>
        </div>
    </div>
    
    <div class="col-md-9">
        <h2 class="mb-4">
            <i class="bi bi-plus-circle"></i> Create Challenge
        </h2>
        
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="name" class="form-label">Challenge Name *</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="category" class="form-label">Category *</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="web">Web</option>
                                <option value="crypto">Crypto</option>
                                <option value="pwn">Pwn</option>
                                <option value="reverse">Reverse</option>
                                <option value="forensics">Forensics</option>
                                <option value="misc">Misc</option>
                                <option value="osint">OSINT</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description *</label>
                        <textarea class="form-control" id="description" name="description" 
                                  rows="6" required></textarea>
                        <div class="form-text">Supports plain text (line breaks preserved)</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="flag" class="form-label">Primary Flag *</label>
                            <input type="text" class="form-control" id="flag" name="flag" 
                                   placeholder="flag{example}" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="flag_case_sensitive" class="form-label">Case Sensitive</label>
                            <select class="form-select" id="flag_case_sensitive" name="flag_case_sensitive">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="difficulty" class="form-label">Difficulty</label>
                            <select class="form-select" id="difficulty" name="difficulty">
                                <option value="">-</option>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Additional Flags Section -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-flag"></i> Additional Flags (Optional - for branching/multiple solutions)
                        </label>
                        <div id="flags-container">
                            <!-- Additional flags will be added here -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addFlag()">
                            <i class="bi bi-plus-circle"></i> Add Alternative Flag
                        </button>
                        <div class="form-text mt-2">
                            Add multiple flags for different solution paths or branching challenges.
                            Configure branching after creating the challenge.
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="initial_points" class="form-label">Initial Points</label>
                            <input type="number" class="form-control" id="initial_points" 
                                   name="initial_points" value="500" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="minimum_points" class="form-label">Minimum Points</label>
                            <input type="number" class="form-control" id="minimum_points" 
                                   name="minimum_points" value="50" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="decay_solves" class="form-label">Decay Solves</label>
                            <input type="number" class="form-control" id="decay_solves" 
                                   name="decay_solves" value="30" min="1">
                            <div class="form-text">Solves to reach minimum</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="max_attempts" class="form-label">Max Attempts</label>
                            <input type="number" class="form-control" id="max_attempts" 
                                   name="max_attempts" value="0" min="0">
                            <div class="form-text">0 = unlimited</div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="author" class="form-label">Author</label>
                            <input type="text" class="form-control" id="author" name="author">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="is_visible" class="form-label">Visible</label>
                            <select class="form-select" id="is_visible" name="is_visible">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="is_dynamic" class="form-label">Dynamic Scoring</label>
                            <select class="form-select" id="is_dynamic" name="is_dynamic">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="requires_team" class="form-label">Requires Team</label>
                            <select class="form-select" id="requires_team" name="requires_team">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="difficulty" class="form-label">Difficulty</label>
                            <select class="form-select" id="difficulty" name="difficulty">
                                <option value="">-</option>
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Hints Section -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-lightbulb"></i> Hints (Optional)
                        </label>
                        <div id="hints-container">
                            <!-- Hints will be added here dynamically -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addHint()">
                            <i class="bi bi-plus-circle"></i> Add Hint
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label for="files" class="form-label">
                            <i class="bi bi-file-earmark-arrow-up"></i> Upload Files
                        </label>
                        <input type="file" class="form-control" id="files" name="files" multiple>
                        <div class="form-text">
                            Upload challenge files (max 50MB per file). Supports: images, archives, executables, etc.
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('admin.manage_challenges') }}" class="btn btn-secondary">
                            <i class="bi bi-x"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Create Challenge
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let hintCount = 0;
let flagCount = 0;

function addFlag() {
    flagCount++;
    const container = document.getElementById('flags-container');
    const flagDiv = document.createElement('div');
    flagDiv.className = 'card mb-2';
    flagDiv.id = `additional-flag-${flagCount}`;
    flagDiv.innerHTML = `
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Flag Value</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="additional_flags[]" placeholder="flag{alternative}" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Label (Optional)</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="flag_labels[]" placeholder="Path A, Hard Route, etc.">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Points Override</label>
                    <input type="number" class="form-control form-control-sm" 
                           name="flag_points[]" placeholder="Leave blank for default">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Case Sensitive</label>
                    <select class="form-select form-select-sm" name="flag_case[]">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-sm btn-danger" 
                            onclick="removeFlag(${flagCount})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    container.appendChild(flagDiv);
}

function removeFlag(id) {
    const flagDiv = document.getElementById(`additional-flag-${id}`);
    if (flagDiv) {
        flagDiv.remove();
    }
}

function addHint() {
    hintCount++;
    const container = document.getElementById('hints-container');
    const hintDiv = document.createElement('div');
    hintDiv.className = 'card mb-2';
    hintDiv.id = `hint-${hintCount}`;
    hintDiv.innerHTML = `
        <div class="card-body">
            <div class="row">
                <div class="col-md-2">
                    <label class="form-label">Order</label>
                    <input type="number" class="form-control form-control-sm" 
                           name="hint_order[]" value="${hintCount}" min="1">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Cost (Points)</label>
                    <input type="number" class="form-control form-control-sm" 
                           name="hint_cost[]" value="10" min="0" required>
                </div>
                <div class="col-md-7">
                    <label class="form-label">Hint Content</label>
                    <textarea class="form-control form-control-sm" name="hint_content[]" 
                              rows="2" required placeholder="Enter hint text..."></textarea>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-sm btn-danger" 
                            onclick="removeHint(${hintCount})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    container.appendChild(hintDiv);
}

function removeHint(id) {
    const hintDiv = document.getElementById(`hint-${id}`);
    if (hintDiv) {
        hintDiv.remove();
    }
}
</script>
{% endblock %}
