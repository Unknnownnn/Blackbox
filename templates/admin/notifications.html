{% extends 'base.html' %}
{% block title %}Admin - Notifications{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-3">
        {% include 'admin/_sidebar.html' %}
    </div>
    <div class="col-md-9">
        <h3>Send Notification</h3>
        <form method="post">
            <div class="mb-3">
                <label class="form-label">Title</label>
                <input type="text" name="title" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Message</label>
                <textarea name="body" class="form-control" rows="5" required></textarea>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" value="true" id="play_sound" name="play_sound" checked>
                <label class="form-check-label" for="play_sound">Play sound for recipients</label>
            </div>
            <button class="btn btn-primary">Send to All</button>
        </form>

        <hr/>
        <h4>Recent Notifications</h4>
        <ul class="list-group">
            {% for n in notifications %}
            <li class="list-group-item" data-notif-id="{{ n.id }}">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>{{ n.title }}</strong>
                        <div class="small text-muted">{{ n.created_at | default('') }}</div>
                    </div>
                    <div>
                        <small class="text-muted">Play sound: {{ 'Yes' if n.play_sound else 'No' }}</small>
                        <div class="mt-1">
                            <button class="btn btn-sm btn-danger delete-notif" data-id="{{ n.id }}">Delete</button>
                        </div>
                    </div>
                </div>
                <div class="mt-1">{{ n.body }}</div>
            </li>
            {% else %}
            <li class="list-group-item">No notifications sent yet.</li>
            {% endfor %}
        </ul>
    </div>
</div>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Connect to websocket to receive deletion events in real-time
    const socket = io('/live');

    socket.on('notification_deleted', function(payload) {
        const id = payload.id;
        const el = document.querySelector(`[data-notif-id='${id}']`);
        if (el) {
            el.style.transition = 'opacity 0.3s';
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 300);
        }
    });

    document.querySelectorAll('.delete-notif').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const id = this.dataset.id;
            if (!id) return;
            if (!confirm('Delete this notification for all users?')) return;
            fetch(`/api/notifications/${id}/delete`, { method: 'POST', credentials: 'same-origin', headers: { 'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content') } })
                .then(res => res.json())
                .then(data => {
                    if (data && data.success) {
                        const el = document.querySelector(`[data-notif-id='${id}']`);
                        if (el) {
                            el.style.transition = 'opacity 0.3s';
                            el.style.opacity = '0';
                            setTimeout(() => el.remove(), 300);
                        }
                    } else {
                        alert('Failed to delete notification');
                    }
                }).catch(() => alert('Failed to delete notification'));
        });
    });
});
</script>
{% endblock %}
