{% extends "base.html" %}

{% block title %}Manage Users - Admin - {{ ctf_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        {% include 'admin/_sidebar.html' %}
    </div>
    
    <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="bi bi-people"></i> Users
            </h2>
            <span class="text-muted">Total: {{ users|length }}</span>
        </div>
        
        {% if users %}
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Team</th>
                                <th>Score</th>
                                <th>Admin</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr id="user-{{ user.id }}">
                                <td>
                                    <strong>{{ user.username }}</strong>
                                    {% if user.is_team_captain %}
                                    <i class="bi bi-shield-fill text-warning" title="Team Captain"></i>
                                    {% endif %}
                                </td>
                                <td>{{ user.email }}</td>
                                <td>
                                    {% if user.team %}
                                    <a href="{{ url_for('teams.view_team', team_id=user.team.id) }}">
                                        {{ user.team.name }}
                                    </a>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ user.get_score() }}</span>
                                    <button class="btn btn-sm btn-link p-0 ms-1" 
                                            onclick="showScoreModal({{ user.id }}, '{{ user.username }}', {{ user.get_score() }}, 'user')">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                </td>
                                <td>
                                    <span class="badge {% if user.is_admin %}bg-danger{% else %}bg-secondary{% endif %}" 
                                          id="admin-badge-{{ user.id }}">
                                        {{ 'Yes' if user.is_admin else 'No' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {% if user.is_active %}bg-success{% else %}bg-warning{% endif %}" 
                                          id="status-badge-{{ user.id }}">
                                        {{ 'Active' if user.is_active else 'Inactive' }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="toggleAdmin({{ user.id }})" 
                                                title="Toggle Admin"
                                                {% if user.id == current_user.id %}disabled{% endif %}>
                                            <i class="bi bi-shield"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" 
                                                onclick="toggleActive({{ user.id }})" 
                                                title="Toggle Active"
                                                {% if user.id == current_user.id %}disabled{% endif %}>
                                            <i class="bi bi-person-check"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No users registered yet.
        </div>
        {% endif %}
    </div>
</div>

<!-- Score Management Modal -->
<div class="modal fade" id="scoreModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Score - <span id="target-name"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Current Score</h6>
                                <h3 class="mb-0"><span class="badge bg-primary" id="current-score"></span> points</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Manual Points Adjustment -->
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-plus-circle"></i> Manual Points Adjustment
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="points-delta" class="form-label">Points to Add/Subtract</label>
                                <input type="number" class="form-control" id="points-delta" 
                                       placeholder="Enter positive or negative number" value="0">
                                <div class="form-text">
                                    Positive numbers add points, negative subtract
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Quick Actions</label>
                                <div class="btn-group d-flex" role="group">
                                    <button class="btn btn-outline-success btn-sm" onclick="setPointsDelta(100)">+100</button>
                                    <button class="btn btn-outline-success btn-sm" onclick="setPointsDelta(50)">+50</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="setPointsDelta(-50)">-50</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="setPointsDelta(-100)">-100</button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="points-reason" class="form-label">Reason</label>
                            <input type="text" class="form-control" id="points-reason" 
                                   placeholder="e.g., Bonus for participation, Penalty for rule violation">
                        </div>
                        <button class="btn btn-primary w-100" onclick="adjustPoints()">
                            <i class="bi bi-check-circle"></i> Apply Point Adjustment
                        </button>
                    </div>
                </div>
                
                <!-- Solve History -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-list-check"></i> Recent Solves & Adjustments
                    </div>
                    <div class="card-body" id="solve-history">
                        <div class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            Loading history...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTargetId = null;
let currentTargetType = null;
let scoreModal = null;

document.addEventListener('DOMContentLoaded', function() {
    scoreModal = new bootstrap.Modal(document.getElementById('scoreModal'));
});

function showScoreModal(id, name, currentScore, type) {
    currentTargetId = id;
    currentTargetType = type;
    document.getElementById('target-name').textContent = name;
    document.getElementById('current-score').textContent = currentScore;
    document.getElementById('points-delta').value = 0;
    document.getElementById('points-reason').value = '';
    
    // Load solve history
    loadSolveHistory(id, type);
    
    scoreModal.show();
}

function setPointsDelta(value) {
    document.getElementById('points-delta').value = value;
}

function loadSolveHistory(id, type) {
    const endpoint = type === 'user' 
        ? `/admin/users/${id}/solves`
        : `/admin/teams/${id}/solves`;
    
    fetch(endpoint)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySolveHistory(data.solves);
            } else {
                document.getElementById('solve-history').innerHTML = 
                    '<p class="text-muted">No solve history available</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('solve-history').innerHTML = 
                '<p class="text-danger">Error loading history</p>';
        });
}

function displaySolveHistory(solves) {
    const container = document.getElementById('solve-history');
    
    if (solves.length === 0) {
        container.innerHTML = '<p class="text-muted">No solves yet</p>';
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    solves.slice(0, 10).forEach(solve => {
        const isAdjustment = !solve.challenge_name;
        const icon = isAdjustment ? 'bi-gear' : 'bi-flag-fill';
        const badgeClass = solve.points >= 0 ? 'bg-success' : 'bg-danger';
        
        html += `
            <div class="list-group-item px-0">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi ${icon} me-2"></i>
                        <strong>${isAdjustment ? 'Manual Adjustment' : solve.challenge_name}</strong>
                        ${solve.reason ? '<br><small class="text-muted ms-4">' + solve.reason + '</small>' : ''}
                    </div>
                    <div class="text-end">
                        <span class="badge ${badgeClass}">${solve.points >= 0 ? '+' : ''}${solve.points}</span>
                        <br><small class="text-muted">${formatDate(solve.solved_at)}</small>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    if (solves.length > 10) {
        html += `<p class="text-muted text-center mt-2 mb-0">Showing 10 of ${solves.length} solves</p>`;
    }
    
    container.innerHTML = html;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) {
        const hours = Math.floor(diff / (1000 * 60 * 60));
        if (hours === 0) {
            const minutes = Math.floor(diff / (1000 * 60));
            return minutes <= 1 ? 'Just now' : `${minutes}m ago`;
        }
        return `${hours}h ago`;
    } else if (days === 1) {
        return 'Yesterday';
    } else if (days < 7) {
        return `${days}d ago`;
    }
    return date.toLocaleDateString();
}

function adjustPoints() {
    const delta = parseInt(document.getElementById('points-delta').value);
    const reason = document.getElementById('points-reason').value;
    
    if (isNaN(delta) || delta === 0) {
        alert('Please enter a valid non-zero number');
        return;
    }
    
    const endpoint = currentTargetType === 'user' 
        ? `/admin/users/${currentTargetId}/adjust-points`
        : `/admin/teams/${currentTargetId}/adjust-points`;
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            points: delta,
            reason: reason || 'Manual adjustment by admin'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFlash(data.message, 'success');
            // Update current score display
            document.getElementById('current-score').textContent = data.new_score;
            // Reload solve history
            loadSolveHistory(currentTargetId, currentTargetType);
            // Reset form
            document.getElementById('points-delta').value = 0;
            document.getElementById('points-reason').value = '';
            // Reload page after 2 seconds to update table
            setTimeout(() => location.reload(), 2000);
        } else {
            showFlash(data.message || 'Error adjusting points', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showFlash('Error adjusting points', 'danger');
    });
}

function toggleAdmin(userId) {
    fetch(`/admin/users/${userId}/toggle-admin`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const badge = document.getElementById(`admin-badge-${userId}`);
            badge.textContent = data.is_admin ? 'Yes' : 'No';
            badge.className = `badge ${data.is_admin ? 'bg-danger' : 'bg-secondary'}`;
            showFlash(data.message, 'success');
        } else {
            showFlash(data.message || 'Error updating admin status', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showFlash('Error updating admin status', 'danger');
    });
}

function toggleActive(userId) {
    fetch(`/admin/users/${userId}/toggle-active`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const badge = document.getElementById(`status-badge-${userId}`);
            badge.textContent = data.is_active ? 'Active' : 'Inactive';
            badge.className = `badge ${data.is_active ? 'bg-success' : 'bg-warning'}`;
            showFlash(data.message, 'success');
        } else {
            showFlash(data.message || 'Error updating user status', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showFlash('Error updating user status', 'danger');
    });
}

function showFlash(message, type) {
    const flashContainer = document.querySelector('.container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    flashContainer.insertBefore(alert, flashContainer.firstChild);
    setTimeout(() => alert.remove(), 5000);
}
</script>
{% endblock %}
