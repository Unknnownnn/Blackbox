{% extends "base.html" %}

{% block title %}Manage Challenges - Admin - {{ ctf_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        {% include 'admin/_sidebar.html' %}
    </div>
    
    <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="bi bi-puzzle"></i> Challenges
            </h2>
            <div class="d-flex align-items-center gap-2">
                <form id="sortForm" method="get" class="d-flex align-items-center gap-2">
                    <label for="sortSelect" class="visually-hidden">Sort</label>
                    <select id="sortSelect" name="sort" class="form-select form-select-sm">
                        <option value="name" {% if current_sort == 'name' %}selected{% endif %}>Name</option>
                        <option value="act" {% if current_sort == 'act' %}selected{% endif %}>ACT</option>
                    </select>
                    <input type="hidden" name="order" id="orderInput" value="{{ current_order or 'asc' }}">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="toggleOrderBtn" title="Toggle order">
                        <i class="bi bi-arrow-down-up" id="orderIcon"></i>
                    </button>
                </form>
                <a href="{{ url_for('admin.create_challenge') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create Challenge
            </a>
            </div>
        </div>
        
        {% if challenges %}
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>ACT</th>
                                <th>Category</th>
                                <th>Points</th>
                                <th>Solves</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for challenge in challenges %}
                            <tr id="challenge-{{ challenge.id }}">
                                <td>
                                    <strong>{{ challenge.name }}</strong>
                                    {% if challenge.is_dynamic %}
                                    <span class="badge bg-info text-white ms-1">Dynamic</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">{{ challenge.act }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ challenge.category }}</span>
                                </td>
                                <td>
                                    {{ challenge.get_current_points() }}
                                    {% if challenge.is_dynamic %}
                                    <small class="text-muted">
                                        ({{ challenge.initial_points }}-{{ challenge.minimum_points }})
                                    </small>
                                    {% endif %}
                                </td>
                                <td>{{ challenge.solve_count }}</td>
                                <td>
                                    <div class="status-badges">
                                        {% if not challenge.is_enabled %}
                                        <span class="badge bg-danger" id="enabled-badge-{{ challenge.id }}">
                                            <i class="bi bi-x-circle"></i> Disabled
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success" id="enabled-badge-{{ challenge.id }}">
                                            <i class="bi bi-check-circle"></i> Enabled
                                        </span>
                                        {% endif %}
                                        
                                        {% if not challenge.is_visible %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-eye-slash"></i> Hidden
                                        </span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('admin.edit_challenge', challenge_id=challenge.id) }}" 
                                           class="btn btn-outline-primary" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button type="button" 
                                                class="btn btn-outline-{% if challenge.is_enabled %}warning{% else %}success{% endif %}" 
                                                onclick="toggleEnabled({{ challenge.id }}, {{ 'true' if challenge.is_enabled else 'false' }})" 
                                                id="toggle-btn-{{ challenge.id }}"
                                                title="{% if challenge.is_enabled %}Disable{% else %}Enable{% endif %}">
                                            <i class="bi bi-{% if challenge.is_enabled %}eye-slash{% else %}eye{% endif %}" 
                                               id="toggle-icon-{{ challenge.id }}"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="deleteChallenge({{ challenge.id }}, '{{ challenge.name }}')" 
                                                title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No challenges created yet. 
            <a href="{{ url_for('admin.create_challenge') }}">Create your first challenge</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
function toggleEnabled(id, currentlyEnabled) {
    fetch(`/admin/challenges/${id}/toggle-enabled`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const newState = data.is_enabled;
            
            // Update badge
            const badge = document.getElementById(`enabled-badge-${id}`);
            if (newState) {
                badge.className = 'badge bg-success';
                badge.innerHTML = '<i class="bi bi-check-circle"></i> Enabled';
            } else {
                badge.className = 'badge bg-danger';
                badge.innerHTML = '<i class="bi bi-x-circle"></i> Disabled';
            }
            
            // Update button
            const button = document.getElementById(`toggle-btn-${id}`);
            const icon = document.getElementById(`toggle-icon-${id}`);
            if (newState) {
                button.className = 'btn btn-outline-warning btn-sm';
                button.title = 'Disable';
                icon.className = 'bi bi-eye-slash';
            } else {
                button.className = 'btn btn-outline-success btn-sm';
                button.title = 'Enable';
                icon.className = 'bi bi-eye';
            }
            
            showFlash(`Challenge ${newState ? 'enabled' : 'disabled'} successfully`, 'success');
        } else {
            showFlash(data.message || 'Error toggling challenge', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showFlash('Error toggling challenge', 'danger');
    });
}

function deleteChallenge(id, name) {
    if (!confirm(`Are you sure you want to delete "${name}"? This cannot be undone.`)) {
        return;
    }
    
    fetch(`/admin/challenges/${id}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`challenge-${id}`).remove();
            showFlash('Challenge deleted successfully', 'success');
        } else {
            showFlash(data.message || 'Error deleting challenge', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showFlash('Error deleting challenge', 'danger');
    });
}

function showFlash(message, type) {
    const flashContainer = document.querySelector('.container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    flashContainer.insertBefore(alert, flashContainer.firstChild);
    setTimeout(() => alert.remove(), 5000);
}

// Sorting controls
document.addEventListener('DOMContentLoaded', function() {
    const sortSelect = document.getElementById('sortSelect');
    const sortForm = document.getElementById('sortForm');
    const orderInput = document.getElementById('orderInput');
    const toggleOrderBtn = document.getElementById('toggleOrderBtn');
    const orderIcon = document.getElementById('orderIcon');

    if (sortSelect) {
        sortSelect.addEventListener('change', () => sortForm.submit());
    }

    if (toggleOrderBtn) {
        toggleOrderBtn.addEventListener('click', () => {
            const current = orderInput.value === 'desc' ? 'desc' : 'asc';
            const next = current === 'asc' ? 'desc' : 'asc';
            orderInput.value = next;
            // update icon orientation
            if (next === 'desc') {
                orderIcon.className = 'bi bi-arrow-down';
            } else {
                orderIcon.className = 'bi bi-arrow-up';
            }
            sortForm.submit();
        });
    }
    // initialize icon based on current order
    try {
        const currentOrder = '{{ current_order or "asc" }}';
        if (currentOrder === 'desc') orderIcon.className = 'bi bi-arrow-down'; else orderIcon.className = 'bi bi-arrow-up';
    } catch (e) {}
});
</script>
{% endblock %}
